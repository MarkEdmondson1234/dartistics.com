<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Pivoting Data within a Query</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="includes/styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}

.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">GA & R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li>
  <a href="setup.html">Initial Setup</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Basic Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="simple-trended-sessions-by-devicecategory.html">Trended Sessions by Device Category</a>
    </li>
    <li>
      <a href="simple-dim-filter.html">Simple Dimension Filter</a>
    </li>
    <li>
      <a href="simple-medium-ordered-by-sessions.html">Medium Ordered by Sessions</a>
    </li>
    <li>
      <a href="segment-by-id.html">Apply Segment by Segment ID</a>
    </li>
    <li>
      <a href="pivot-in-query.html">Pivot in a Query</a>
    </li>
    <li>
      <a href="pivot-after-query.html">Pivot After a Query</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Intermediate Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="pivot-sparklines-heatmap.html">2D Sparklines/Heatmap</a>
    </li>
    <li>
      <a href="simple-dynamic-segment.html">Simple Dynamic Segment - v4</a>
    </li>
    <li>
      <a href="simple-dynamic-segment-v3.html">Simple Dynamic Segment - v3</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://dartistics.com">dartistics.com</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-N4DF7T"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-N4DF7T');</script>
<!-- End Google Tag Manager -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Pivoting Data within a Query</h1>

</div>


<p><strong>IMPORTANT NOTE: There is a bug in the Google Analytics v4 API that actually makes this example only partially functional (and not partially enough to make it work). Be sure to read the full intro here for an explanation!</strong></p>
<p>This example pulls sessions by <strong>device category</strong> and <strong>medium</strong>, but uses pivoting <em>within the call to Google Analytics</em> so that the <strong>device category</strong> values are across the columns, while the <strong>medium</strong> values are in the rows. Generally, this is a bit of an odd thing to do for a couple of reasons:</p>
<ul>
<li>This may be personal preference, but it’s awfully easy to do the pivoting with the <code>spread()</code> function in <code>dplyr</code> after it’s been pulled as a flat/simple query.</li>
<li>Generally, tidy data is, well, tidier. And, tidy data means pull the data…unpivoted.</li>
</ul>
<p>But, it IS doable…except there is a bug in the API when it comes to pulling pivoted data – a column can get dropped! Check out the <a href="https://github.com/MarkEdmondson1234/googleAnalyticsR/issues/107">issue on Github</a> for an update.</p>
<p>Even without the bug, I consider this approach vastly inferior to the approach used in <a href="pivot-after-query.html">Pivoting the Data (after Querying) example</a>.</p>
<div id="setupconfig" class="section level1">
<h1>Setup/Config</h1>
<p>Be sure you’ve completed the steps on the <a href="setup.html">Initial Setup</a> page before running this code.</p>
<p>For the setup, we’re going to load a few libraries, load our specific Google Analytics credentials, and then authorize with Google.</p>
<pre class="r"><code># Load the necessary libraries
library(googleAnalyticsR)
library(tidyverse)
library(devtools)

# Load the client ID, client secret, and GA view ID
client_id &lt;- Sys.getenv(&quot;GA_CLIENT_ID&quot;)
client_secret &lt;- Sys.getenv(&quot;GA_CLIENT_SECRET&quot;)

# Set the client ID and client secret as options for googleAuthR
options(googleAuthR.client_id = client_id)
options(googleAuthR.client_secret = client_secret)

# Reload the googleAnalyticsR package so those options get set in googleAuthR
devtools::reload(pkg = devtools::inst(&quot;googleAnalyticsR&quot;))

# Authorize GA. Depending on if you&#39;ve done this already and a .httr-oauth file has
# been saved or not, this may pop you over to a browser to authenticate.
ga_auth()

# Set the view ID and the date range. If you want to, you can swap out the Sys.getenv()
# call and just replace that with a hardcoded value for the view ID. And, the start 
# and end date are currently set to choose the last 30 days, but those can be 
# hardcoded as well.
view_id &lt;- Sys.getenv(&quot;GA_VIEW_ID&quot;)
start_date &lt;- Sys.Date() - 31        # 30 days back from yesterday
end_date &lt;- Sys.Date() - 1           # Yesterday</code></pre>
<p>If that all runs with just some messages but no errors, then you’re set for the next chunk of code: pulling the data.</p>
</div>
<div id="pull-the-data" class="section level1">
<h1>Pull the Data</h1>
<p>We have to, first, define what we’re going to pivot. After that, it’s a pretty straightforward query.</p>
<pre class="r"><code># Start by defining the pivot object. See ?pivot_ga4() for details.
my_pivot_object &lt;- pivot_ga4(&quot;deviceCategory&quot;,
                             metrics = &quot;sessions&quot;)

# Pull the data. See ?google_analytics_4() for additional parameters. The anti_sample = TRUE
# parameter will slow the query down a smidge and isn&#39;t strictly necessary, but it will
# ensure you do not get sampled data.
ga_data &lt;- google_analytics_4(viewId = view_id,
                              date_range = c(start_date, end_date),
                              metrics = &quot;sessions&quot;,
                              dimensions = &quot;medium&quot;,
                              pivots = list(my_pivot_object),
                              anti_sample = TRUE)

# Go ahead and do a quick inspection of the data that was returned. This isn&#39;t required,
# but it&#39;s a good check along the way.
head(ga_data)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">medium</th>
<th align="right">sessions</th>
<th align="right">deviceCategory.mobile.sessions</th>
<th align="right">deviceCategory.tablet.sessions</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(none)</td>
<td align="right">4479</td>
<td align="right">609</td>
<td align="right">161</td>
</tr>
<tr class="even">
<td align="left">Community</td>
<td align="right">6</td>
<td align="right">6</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">email</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">feed</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">gplus</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">organic</td>
<td align="right">25815</td>
<td align="right">1552</td>
<td align="right">422</td>
</tr>
</tbody>
</table>
<p>This is the apparent/possible bug noted in the intro – we seem to be missing a column! Check out the <a href="https://github.com/MarkEdmondson1234/googleAnalyticsR/issues/107">issue on Github</a> for an update.</p>
</div>
<div id="data-munging" class="section level1">
<h1>Data Munging</h1>
<p>The column headings are pretty ugly and redundant, and the <strong>sessions</strong> column isn’t necessarily one we’d want to keep, so let’s do a little cleanup.</p>
<pre class="r"><code># Remove the &#39;sessions&#39; column
ga_data &lt;- select(ga_data, -sessions)

# Use a little regEx to strip out &quot;deviceCategory&quot; and &quot;sessions&quot; from the column names
names(ga_data) &lt;- gsub(&quot;deviceCategory\\.(.*)\\.sessions&quot;,&quot;\\1&quot;, names(ga_data))

# Check out the result of our handiwork
head(ga_data)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">medium</th>
<th align="right">mobile</th>
<th align="right">tablet</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(none)</td>
<td align="right">609</td>
<td align="right">161</td>
</tr>
<tr class="even">
<td align="left">Community</td>
<td align="right">6</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">email</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">feed</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">gplus</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">organic</td>
<td align="right">1552</td>
<td align="right">422</td>
</tr>
</tbody>
</table>
</div>
<div id="data-visualization" class="section level1">
<h1>Data Visualization</h1>
<p>This could be a nice little heatmap, but to do that with ggplot2, we’d have to gather it up into a tidy format. Basically…unpivot it! That seems silly – better to have pulled it unpivoted! I’m taking a moral stance and not jumping through that particular set of hoops for this example.</p>
</div>

<hr>
<p align="center"><em></em>This site is a sub-site to <a href="http://dartistics.com" target="_blank">dartistics.com</em></p>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
