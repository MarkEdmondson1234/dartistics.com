<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Simple Dynamic Segment - v4</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/simplex.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="includes/styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 41px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 46px;
  margin-top: -46px;
}

.section h2 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h3 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h4 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h5 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h6 {
  padding-top: 46px;
  margin-top: -46px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">GA & R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li>
  <a href="setup.html">Initial Setup</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Basic Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="simple-trended-sessions-by-medium.html">Trended Sessions by Medium</a>
    </li>
    <li>
      <a href="simple-dim-filter.html">Simple Dimension Filter</a>
    </li>
    <li>
      <a href="simple-medium-ordered-by-sessions.html">Medium Ordered by Sessions</a>
    </li>
    <li>
      <a href="segment-by-id.html">Apply Segment by Segment ID</a>
    </li>
    <li>
      <a href="pivot-in-query.html">Pivot in a Query</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Intermediate Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="pivot-sparklines-heatmap.html">2D Sparklines/Heatmap</a>
    </li>
    <li>
      <a href="simple-dynamic-segment.html">Simple Dynamic Segment - v4</a>
    </li>
    <li>
      <a href="simple-dynamic-segment-v3.html">Simple Dynamic Segment - v3</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-N4DF7T"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-N4DF7T');</script>
<!-- End Google Tag Manager -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Simple Dynamic Segment - v4</h1>

</div>


<p>This example pulls the top 10 pages for the last thirty days, <em>for visits that occurred on a mobile device</em>. For the sake of illustration, we’re going to build this segment <em>dynamically</em> rather than referencing a segment ID. Where this can come in handy is if you have a script where you want to work through a range of small little tweaks to one segment and re-pull the data. You don’t want to build each segment in the web interface and then hardcode all those IDs! We may add an example for doing that later, but we’re doing to keep this very simple for now.</p>
<p>This returns the exact same results as these two examples, but through different means for defining/referencing the segment:</p>
<ul>
<li><strong><a href="simple-dynamic-segment-v3.html">Simple Dynamic Segment - v3</a></strong> – Ahhhhh! The days when dynamic segments were so much simpler (but also less powerful)</li>
<li><strong><a href="segment-by-id.html">Apply Segment by Segment ID</a></strong> – simply using the ID of either a standard segment or a custom segment built in the Google Analytics web interface</li>
</ul>
<p>With the v4 API, dynamic segments are more powerful than v3, but (alas!) pretty basic segments can feel pretty convoluted.</p>
<div id="setupconfig" class="section level1">
<h1>Setup/Config</h1>
<p>Be sure you’ve completed the steps on the <a href="setup.html">Initial Setup</a> page before running this code.</p>
<p>For the setup, we’re going to load a few libraries, load our specific Google Analytics credentials, and then authorize with Google.</p>
<pre class="r"><code># Load the necessary libraries
library(googleAnalyticsR)
library(tidyverse)
library(devtools)

# Load the client ID, client secret, and GA view ID
client_id &lt;- Sys.getenv(&quot;GA_CLIENT_ID&quot;)
client_secret &lt;- Sys.getenv(&quot;GA_CLIENT_SECRET&quot;)

# Set the client ID and client secret as options for googleAuthR
options(googleAuthR.client_id = client_id)
options(googleAuthR.client_secret = client_secret)

# Reload the googleAnalyticsR package so those options get set in googleAuthR
devtools::reload(pkg = devtools::inst(&quot;googleAnalyticsR&quot;))

# Authorize GA. Depending on if you&#39;ve done this already and a .httr-oauth file has
# been saved or not, this may pop you over to a browser to authenticate.
ga_auth()

# Set the view ID and the date range. If you want to, you can swap out the Sys.getenv()
# call and just replace that with a hardcoded value for the view ID. And, the start 
# and end date are currently set to choose the last 30 days, but those can be 
# hardcoded as well.
view_id &lt;- Sys.getenv(&quot;GA_VIEW_ID&quot;)
start_date &lt;- Sys.Date() - 31        # 30 days back from yesterday
end_date &lt;- Sys.Date() - 1           # Yesterday</code></pre>
<p>If that all runs with just some messages but no errors, then you’re set for the next chunk of code: pulling the data.</p>
</div>
<div id="pull-the-data" class="section level1">
<h1>Pull the Data</h1>
<p>This all gets built up in what can feel very cumbersome. Check out <code>?segment_ga4()</code> for the documentation of how the segment gets built. Correctly, it describes this as a “hierarchy.” In practical terms, though, we build from the bottom up:</p>
<ol style="list-style-type: decimal">
<li>Define a <em>segment element</em> using <code>segment_element()</code>. This is just a single conditional statement.</li>
<li>Combine one or more segment elements together into a <em>segment vector</em> using <code>segment_vector_simple()</code>. There are a few options here, but we’re going to stick with the simple approach. And, it’s still going to feel redundant, because we’re only including a single segment element.</li>
<li>Combine one or more <em>segment vectors</em> into a <em>segment definition</em> using <code>segment_define()</code>. This may feel like it’s the same as the previous step, but, if you think about the segment builder in the web interface, it will start to make sense – there are two levels at which can combine multiple “things” together to define a segment. Alas! Here, again, we’re just including a single segment vector, so it all feels really cumbersome.</li>
<li>Put <em>that</em> into a <em>segment object</em>, which is what we’re actually going to use in the data. We actually give the segment a name here that will be returned in the results.</li>
<li>Actually pull the data, passing in the <em>segment object</em> as an argument.</li>
</ol>
<p>In addition to the “hierarchy” messiness for a simple segment, there is also some <code>list()</code> messiness. Note, for instance, how <code>my_segment_vector</code> in the example code includes a list within a list. Use this example (and other examples on this site) as well as the <code>?segment_ga4()</code> documentation to troubleshoot.</p>
<pre class="r"><code># Create a segment element object. See ?segment_element() for details.
my_segment_element &lt;- segment_element(&quot;deviceCategory&quot;, 
                                   operator = &quot;EXACT&quot;,
                                   type = &quot;DIMENSION&quot;,
                                   expressions = &quot;Mobile&quot;)

# Create a segment vector that has just one element. See ?segment_vector_simple() for details. Note
# that the element is wrapped in a list(). This is how you would include multiple elements in the
# definition.
my_segment_vector &lt;- segment_vector_simple(list(list(my_segment_element)))

# Define the segment with just the one segment vector in it. See ?segment_define() for details.
my_segment_definition &lt;- segment_define(list(my_segment_vector))

# Create the actual segment object that we&#39;re going to use in the query. See ?segment_ga4()
# for details.
my_segment &lt;- segment_ga4(&quot;Mobile Sessions Only&quot;,
                                 session_segment = my_segment_definition)

# &lt;whew&gt;!!!

# Pull the data. See ?google_analytics_4() for additional parameters. Depending on what
# you&#39;re expecting back, you probably would want to use an &quot;order&quot; argument to get the
# results in descending order. But, we&#39;re keeping this example simple. Note, though, that
# we&#39;re still wrapping my_segment in a list() (of one element).
ga_data &lt;- google_analytics_4(viewId = view_id,
                              date_range = c(start_date, end_date),
                              metrics = &quot;pageviews&quot;,
                              dimensions = &quot;pagePath&quot;,
                              segments = my_segment)

# Go ahead and do a quick inspection of the data that was returned. This isn&#39;t required,
# but it&#39;s a good check along the way. 
head(ga_data)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">pagePath</th>
<th align="left">segment</th>
<th align="right">pageviews</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">/</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">175</td>
</tr>
<tr class="even">
<td align="left">/?author_name=&amp;cat=</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">13</td>
</tr>
<tr class="odd">
<td align="left">/?author_name=&amp;cat=227</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">/?author_name=eric-peterson&amp;cat=</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">/?author_name=eric-peterson&amp;cat=659</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">/?p=43</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
<div id="data-munging" class="section level1">
<h1>Data Munging</h1>
<p>Since we didn’t sort the data when we queried it, let’s go ahead and sort it here <em>and</em> grab just the top 10 pages.</p>
<pre class="r"><code># Using dplyr, sort descending and then grab the top 10 values. We also need to make the
# page column a factor so that the order will be what we want when we chart the data.
# This is a nuisance, but you get used to it. That&#39;s what the mutate functio is doing
ga_data_top_10 &lt;- ga_data %&gt;%
  arrange(-pageviews) %&gt;% 
  top_n(10) %&gt;% 
  mutate(pagePath = factor(pagePath,
                           levels = rev(pagePath)))

# Take a quick look at the result. 
head(ga_data_top_10)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">pagePath</th>
<th align="left">segment</th>
<th align="right">pageviews</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">/excel-tips/converting-a-date-in-excel-to-week-bi-week-month-and-more/</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">184</td>
</tr>
<tr class="even">
<td align="left">/</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">175</td>
</tr>
<tr class="odd">
<td align="left">/excel-tips/excel-dynamic-named-ranges-never-manually-updating-your-charts-2/</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">165</td>
</tr>
<tr class="even">
<td align="left">/excel-tips/excel-dropdowns-done-right/</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">127</td>
</tr>
<tr class="odd">
<td align="left">/adobe-analytics/advanced-click-rates-adobe-analytics-placement/</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">112</td>
</tr>
<tr class="even">
<td align="left">/excel-tips/excel-dynamic-named-ranges-with-tables-never-manually-updating-your-charts/</td>
<td align="left">Mobile Sessions Only</td>
<td align="right">107</td>
</tr>
</tbody>
</table>
</div>
<div id="data-visualization" class="section level1">
<h1>Data Visualization</h1>
<p>This won’t be the prettiest bar chart, but let’s make a horizontal bar chart with the data. Remember, in <strong>ggplot2</strong>, a horizontal bar chart is just a normal bar chart with <code>coord_flip()</code>.</p>
<pre class="r"><code># Create the plot. Note the stat=&quot;identity&quot;&quot; (because the data is already aggregated) and
# the coord_flip(). And, I just can&#39;t stand it... added on the additional theme stuff to
# clean up the plot a bit more.
gg &lt;- ggplot(ga_data_top_10, mapping = aes(x = pagePath, y = pageviews)) +
  geom_bar(stat = &quot;identity&quot;) +
  coord_flip() +
  theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())

# Output the plot. You *could* just remove the &quot;gg &lt;-&quot; in the code above, but it&#39;s
# generally a best practice to create a plot object and then output it, rather than
# outputting it on the fly.
gg</code></pre>
<p><img src="simple-dynamic-segment_files/figure-html/visualize-1.png" width="672" /></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
